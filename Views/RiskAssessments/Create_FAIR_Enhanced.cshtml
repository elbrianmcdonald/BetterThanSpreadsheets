@model CyberRiskApp.ViewModels.FAIRAssessmentViewModel
@{
    ViewData["Title"] = "Create Risk Assessment";
}

<h2>Create Risk Assessment</h2>

<form asp-action="Create" method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    
    <!-- Basic Information -->
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">Basic Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.Title" class="control-label"></label>
                        <input asp-for="Assessment.Title" class="form-control" />
                        <span asp-validation-for="Assessment.Title" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.Asset" class="control-label"></label>
                        <input asp-for="Assessment.Asset" class="form-control" />
                        <span asp-validation-for="Assessment.Asset" class="text-danger"></span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.BusinessUnit" class="control-label"></label>
                        <input asp-for="Assessment.BusinessUnit" class="form-control" />
                        <span asp-validation-for="Assessment.BusinessUnit" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.AssessmentType" class="control-label"></label>
                        <select asp-for="Assessment.AssessmentType" class="form-control" id="assessmentType">
                            <option value="1">FAIR (Quantitative)</option>
                            <option value="0">Qualitative</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label asp-for="Assessment.ThreatScenario" class="control-label"></label>
                <textarea asp-for="Assessment.ThreatScenario" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Assessment.ThreatScenario" class="text-danger"></span>
            </div>
            
            <div class="form-group">
                <label asp-for="Assessment.Description" class="control-label"></label>
                <textarea asp-for="Assessment.Description" class="form-control" rows="3"></textarea>
            </div>
        </div>
    </div>

    <!-- FAIR Analysis Section -->
    <div id="fairSection" class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">FAIR Analysis</h5>
        </div>
        <div class="card-body">
            <!-- Threat Analysis -->
            <h6 class="text-primary">Threat Analysis</h6>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatCommunity" class="control-label"></label>
                        <select asp-for="Assessment.ThreatCommunity" class="form-control">
                            <option value="">Select Threat Community</option>
                            <option value="External Actors">External Actors</option>
                            <option value="Internal Actors">Internal Actors</option>
                            <option value="Trusted Insiders">Trusted Insiders</option>
                            <option value="Privileged Insiders">Privileged Insiders</option>
                            <option value="Partners">Partners</option>
                            <option value="Suppliers">Suppliers</option>
                            <option value="Nation States">Nation States</option>
                            <option value="Organized Crime">Organized Crime</option>
                            <option value="Hacktivists">Hacktivists</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatAction" class="control-label"></label>
                        <select asp-for="Assessment.ThreatAction" class="form-control">
                            <option value="">Select Threat Action</option>
                            <option value="Data Exfiltration">Data Exfiltration</option>
                            <option value="Ransomware">Ransomware</option>
                            <option value="Business Email Compromise">Business Email Compromise</option>
                            <option value="Denial of Service">Denial of Service</option>
                            <option value="Data Manipulation">Data Manipulation</option>
                            <option value="System Compromise">System Compromise</option>
                            <option value="Physical Theft">Physical Theft</option>
                            <option value="Social Engineering">Social Engineering</option>
                            <option value="Supply Chain Attack">Supply Chain Attack</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Threat Event Frequency Distribution -->
            <h6 class="text-primary">Threat Event Frequency (Annual)</h6>
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatEventFrequencyMin" class="control-label">Minimum</label>
                        <input asp-for="Assessment.ThreatEventFrequencyMin" type="number" step="0.1" class="form-control tef-input" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatEventFrequency" class="control-label">Most Likely</label>
                        <input asp-for="Assessment.ThreatEventFrequency" type="number" step="0.1" class="form-control tef-input" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatEventFrequencyMax" class="control-label">Maximum</label>
                        <input asp-for="Assessment.ThreatEventFrequencyMax" type="number" step="0.1" class="form-control tef-input" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Assessment.ThreatEventFrequencyConfidence" class="control-label">Confidence %</label>
                        <select asp-for="Assessment.ThreatEventFrequencyConfidence" class="form-control">
                            <option value="90">90%</option>
                            <option value="95">95%</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Defense in Depth Controls -->
            <h6 class="text-primary">Defense in Depth - Security Controls</h6>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Add security controls to calculate vulnerability reduction. 
                Combined effectiveness: <strong><span id="combinedEffectiveness">0</span>%</strong> | 
                Resulting vulnerability: <strong><span id="resultingVulnerability">100</span>%</strong>
            </div>
            
            <div id="controlsContainer">
                <!-- Controls will be dynamically added here -->
            </div>
            
            <button type="button" class="btn btn-sm btn-primary" onclick="addControl()">
                <i class="fas fa-plus"></i> Add Control
            </button>

            <hr class="my-4" />

            <!-- Primary Loss Magnitude -->
            <h6 class="text-primary">Primary Loss Magnitude Estimates</h6>
            
            <!-- Productivity Loss -->
            <div class="card mb-3">
                <div class="card-header">Productivity Loss</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum ($)</label>
                                <input asp-for="Assessment.ProductivityLossMin" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Most Likely ($)</label>
                                <input asp-for="Assessment.ProductivityLossMostLikely" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Maximum ($)</label>
                                <input asp-for="Assessment.ProductivityLossMax" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Costs -->
            <div class="card mb-3">
                <div class="card-header">Response Costs</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum ($)</label>
                                <input asp-for="Assessment.ResponseCostsMin" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Most Likely ($)</label>
                                <input asp-for="Assessment.ResponseCostsMostLikely" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Maximum ($)</label>
                                <input asp-for="Assessment.ResponseCostsMax" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Replacement Cost -->
            <div class="card mb-3">
                <div class="card-header">Replacement Cost</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum ($)</label>
                                <input asp-for="Assessment.ReplacementCostMin" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Most Likely ($)</label>
                                <input asp-for="Assessment.ReplacementCostMostLikely" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Maximum ($)</label>
                                <input asp-for="Assessment.ReplacementCostMax" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fines/Penalties -->
            <div class="card mb-3">
                <div class="card-header">Fines/Penalties</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Minimum ($)</label>
                                <input asp-for="Assessment.FinesMin" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Most Likely ($)</label>
                                <input asp-for="Assessment.FinesMostLikely" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Maximum ($)</label>
                                <input asp-for="Assessment.FinesMax" type="number" class="form-control loss-input" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secondary Loss Toggle -->
            <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="includeSecondaryLoss" />
                <label class="form-check-label" for="includeSecondaryLoss">
                    Include Secondary Loss Analysis
                </label>
            </div>

            <!-- Secondary Loss Section (Hidden by default) -->
            <div id="secondaryLossSection" style="display: none;">
                <h6 class="text-primary">Secondary Loss Magnitude Estimates</h6>
                
                <!-- Secondary Response Cost -->
                <div class="card mb-3">
                    <div class="card-header">Secondary Response Cost</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input asp-for="Assessment.SecondaryResponseCostMin" type="number" class="form-control" placeholder="Minimum ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.SecondaryResponseCostMostLikely" type="number" class="form-control" placeholder="Most Likely ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.SecondaryResponseCostMax" type="number" class="form-control" placeholder="Maximum ($)" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reputation Damage -->
                <div class="card mb-3">
                    <div class="card-header">Reputation Damage</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input asp-for="Assessment.ReputationDamageMin" type="number" class="form-control" placeholder="Minimum ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.ReputationDamageMostLikely" type="number" class="form-control" placeholder="Most Likely ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.ReputationDamageMax" type="number" class="form-control" placeholder="Maximum ($)" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Competitive Advantage Loss -->
                <div class="card mb-3">
                    <div class="card-header">Competitive Advantage Loss</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input asp-for="Assessment.CompetitiveAdvantageLossMin" type="number" class="form-control" placeholder="Minimum ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.CompetitiveAdvantageLossMostLikely" type="number" class="form-control" placeholder="Most Likely ($)" />
                            </div>
                            <div class="col-md-4">
                                <input asp-for="Assessment.CompetitiveAdvantageLossMax" type="number" class="form-control" placeholder="Maximum ($)" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Settings -->
            <h6 class="text-primary mt-4">Simulation Settings</h6>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="Assessment.SimulationIterations">Monte Carlo Iterations</label>
                        <select asp-for="Assessment.SimulationIterations" class="form-control">
                            <option value="1000">1,000 (Fast)</option>
                            <option value="10000" selected>10,000 (Standard)</option>
                            <option value="100000">100,000 (High Precision)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="Assessment.DistributionType">Distribution Type</label>
                        <select asp-for="Assessment.DistributionType" class="form-control">
                            <option value="PERT">PERT (Recommended)</option>
                            <option value="Normal">Normal</option>
                            <option value="Lognormal">Lognormal</option>
                            <option value="Uniform">Uniform</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="Assessment.LossMagnitudeConfidence">Loss Estimate Confidence</label>
                        <select asp-for="Assessment.LossMagnitudeConfidence" class="form-control">
                            <option value="90">90%</option>
                            <option value="95">95%</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Insurance Deduction -->
            <div class="form-check mb-3">
                <input asp-for="Assessment.DeductCybersecurityInsurance" type="checkbox" class="form-check-input" />
                <label asp-for="Assessment.DeductCybersecurityInsurance" class="form-check-label">
                    Deduct Cybersecurity Insurance from ALE
                </label>
            </div>

            <!-- Real-time Calculation Preview -->
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="text-primary">Estimated Results (Single-Point)</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Vulnerability:</strong> <span id="vulnerabilityPreview">-</span>%
                        </div>
                        <div class="col-md-3">
                            <strong>LEF:</strong> <span id="lefPreview">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Primary Loss:</strong> $<span id="primaryLossPreview">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Est. ALE:</strong> $<span id="alePreview">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Buttons -->
    <div class="form-group">
        <button type="submit" class="btn btn-primary">Create Assessment</button>
        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <script>
        let controlIndex = 0;
        
        // Control management functions
        function addControl() {
            const container = document.getElementById('controlsContainer');
            const controlHtml = `
                <div class="control-item card mb-2" id="control_${controlIndex}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" name="Controls[${controlIndex}].ControlName" 
                                       class="form-control" placeholder="Control Name" required />
                            </div>
                            <div class="col-md-2">
                                <select name="Controls[${controlIndex}].ControlType" class="form-control" required>
                                    <option value="Preventive">Preventive</option>
                                    <option value="Detective">Detective</option>
                                    <option value="Responsive">Responsive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" name="Controls[${controlIndex}].ControlEffectiveness" 
                                       class="form-control control-effectiveness" placeholder="Effectiveness %" 
                                       min="0" max="100" step="1" required onchange="updateVulnerability()" />
                            </div>
                            <div class="col-md-2">
                                <select name="Controls[${controlIndex}].ImplementationStatus" 
                                        class="form-control control-status" onchange="updateVulnerability()" required>
                                    <option value="Implemented">Implemented</option>
                                    <option value="Planned">Planned</option>
                                    <option value="NotImplemented">Not Implemented</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" name="Controls[${controlIndex}].ControlDescription" 
                                       class="form-control" placeholder="Description" />
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeControl(${controlIndex})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', controlHtml);
            controlIndex++;
            updateVulnerability();
        }
        
        function removeControl(index) {
            document.getElementById(`control_${index}`).remove();
            updateVulnerability();
        }
        
        function updateVulnerability() {
            let remainingVulnerability = 1.0;
            
            document.querySelectorAll('.control-item').forEach(item => {
                const effectiveness = parseFloat(item.querySelector('.control-effectiveness').value) || 0;
                const status = item.querySelector('.control-status').value;
                
                if (status === 'Implemented' && effectiveness > 0) {
                    remainingVulnerability *= (1 - effectiveness / 100);
                }
            });
            
            const combinedEffectiveness = (1 - remainingVulnerability) * 100;
            const resultingVulnerability = remainingVulnerability * 100;
            
            document.getElementById('combinedEffectiveness').textContent = combinedEffectiveness.toFixed(2);
            document.getElementById('resultingVulnerability').textContent = resultingVulnerability.toFixed(2);
            document.getElementById('vulnerabilityPreview').textContent = resultingVulnerability.toFixed(2);
            
            updatePreview();
        }
        
        function updatePreview() {
            // Get TEF (most likely)
            const tef = parseFloat(document.querySelector('[name="Assessment.ThreatEventFrequency"]').value) || 0;
            
            // Get vulnerability
            const vulnerability = parseFloat(document.getElementById('resultingVulnerability').textContent) / 100 || 1;
            
            // Calculate LEF
            const lef = tef * vulnerability;
            document.getElementById('lefPreview').textContent = lef.toFixed(3);
            
            // Calculate Primary Loss (most likely values)
            let primaryLoss = 0;
            primaryLoss += parseFloat(document.querySelector('[name="Assessment.ProductivityLossMostLikely"]').value) || 0;
            primaryLoss += parseFloat(document.querySelector('[name="Assessment.ResponseCostsMostLikely"]').value) || 0;
            
            const replacement = parseFloat(document.querySelector('[name="Assessment.ReplacementCostMostLikely"]').value) || 0;
            if (replacement > 1000) primaryLoss += replacement;
            
            const fines = parseFloat(document.querySelector('[name="Assessment.FinesMostLikely"]').value) || 0;
            if (fines > 1000) primaryLoss += fines;
            
            document.getElementById('primaryLossPreview').textContent = primaryLoss.toLocaleString();
            
            // Calculate ALE
            const ale = lef * primaryLoss;
            document.getElementById('alePreview').textContent = ale.toLocaleString();
        }
        
        // Event listeners
        document.getElementById('includeSecondaryLoss').addEventListener('change', function() {
            document.getElementById('secondaryLossSection').style.display = this.checked ? 'block' : 'none';
        });
        
        document.getElementById('assessmentType').addEventListener('change', function() {
            document.getElementById('fairSection').style.display = this.value === '1' ? 'block' : 'none';
        });
        
        // Update preview on input changes
        document.querySelectorAll('.tef-input, .loss-input').forEach(input => {
            input.addEventListener('input', updatePreview);
        });
        
        // Add initial control
        addControl();
    </script>
}
@{
    ViewData["Title"] = "CISO Executive Dashboard";
}

<!-- Include Chart.js for graphs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    /* Professional Executive Dashboard Styling - Business Conservative */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #34495e;
        --accent-color: #3498db;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #8e9aac;
        --light-gray: #ecf0f1;
        --medium-gray: #bdc3c7;
        --dark-gray: #7f8c8d;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        --border-radius-card: 12px;
        --border-radius-small: 6px;
    }

    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .executive-dashboard {
        background: transparent;
        min-height: 100vh;
    }

    .executive-card {
        border: none;
        box-shadow: var(--card-shadow);
        border-radius: var(--border-radius-card);
        transition: all 0.3s ease;
        background: var(--primary-color);
        color: white;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .executive-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.05);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .executive-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-shadow-hover);
    }

    .executive-card:hover::before {
        opacity: 1;
    }

    .metric-critical {
        background: var(--danger-color);
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
    }

    .metric-high {
        background: var(--warning-color);
        background: linear-gradient(135deg, #d68910 0%, #f39c12 100%);
    }

    .metric-medium {
        background: var(--info-color);
        background: linear-gradient(135deg, #7d8ca3 0%, #8e9aac 100%);
    }

    .metric-warning {
        background: var(--warning-color);
        background: linear-gradient(135deg, #d68910 0%, #f39c12 100%);
    }

    .metric-good {
        background: var(--accent-color);
        background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
    }

    .metric-success {
        background: var(--success-color);
        background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
    }

    .chart-executive {
        background: #ffffff;
        border-radius: var(--border-radius-card);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--light-gray);
        transition: all 0.3s ease;
    }

    .chart-executive:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-2px);
    }

    .chart-executive h5 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1.5rem;
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        border-bottom: 2px solid var(--light-gray);
        padding-bottom: 0.75rem;
    }

    .chart-executive h5 i {
        margin-right: 0.75rem;
        font-size: 1.25rem;
        color: var(--accent-color);
    }

    .chart-container {
        position: relative;
        height: 350px !important;
        width: 100%;
        overflow: hidden;
        border-radius: var(--border-radius-small);
    }

    .chart-container canvas {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        max-height: 350px !important;
    }

    .kpi-container {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
        padding: 1.5rem;
    }

    .kpi-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    .kpi-number {
        font-size: 2.75rem;
        font-weight: 700;
        line-height: 1;
        margin: 0.5rem 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .kpi-label {
        font-size: 0.95rem;
        margin: 0;
        opacity: 0.9;
        font-weight: 500;
        line-height: 1.3;
    }

    .dashboard-header {
        background: #ffffff;
        border-radius: var(--border-radius-card);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--light-gray);
    }

    .dashboard-title {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 2.5rem;
    }

    .dashboard-subtitle {
        color: var(--dark-gray);
        font-weight: 400;
        margin-bottom: 0;
        font-size: 1.125rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        background: var(--light-gray);
        color: var(--primary-color);
        border: 1px solid var(--medium-gray);
    }

    .status-badge i {
        margin-right: 0.5rem;
        color: var(--accent-color);
    }

    .refresh-button {
        background: var(--accent-color);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
    }

    .refresh-button:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        color: white;
    }

    .table-modern {
        background: white;
        border-radius: var(--border-radius-small);
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--light-gray);
    }

    .table-modern thead th {
        background: var(--primary-color);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-modern tbody td {
        padding: 1rem;
        border: none;
        border-bottom: 1px solid var(--light-gray);
        vertical-align: middle;
    }

    .table-modern tbody tr:hover {
        background: rgba(236, 240, 241, 0.5);
    }

    .badge-modern {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* New Dashboard Components */
    .metric-info {
        background: var(--info-color);
        background: linear-gradient(135deg, #7d8ca3 0%, #8e9aac 100%);
    }

    .metric-mini {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .metric-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .metric-mini-label {
        font-size: 0.75rem;
        color: var(--dark-gray);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .threat-category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--accent-color);
    }

    .threat-category-name {
        font-weight: 600;
        color: var(--primary-color);
    }

    .threat-category-count {
        background: var(--accent-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .compliance-framework-item {
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid;
    }

    .compliance-framework-item.high-compliance {
        border-left-color: var(--success-color);
    }

    .compliance-framework-item.medium-compliance {
        border-left-color: var(--warning-color);
    }

    .compliance-framework-item.low-compliance {
        border-left-color: var(--danger-color);
    }

    .compliance-rate {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .compliance-framework-name {
        font-size: 0.875rem;
        color: var(--dark-gray);
        margin-bottom: 0.5rem;
    }

    .compliance-gap-count {
        font-size: 0.75rem;
        color: var(--danger-color);
    }

    .investment-priority-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }

    .investment-priority-item.high-priority {
        border-left-color: var(--danger-color);
    }

    .investment-priority-item.medium-priority {
        border-left-color: var(--warning-color);
    }

    .investment-priority-item.low-priority {
        border-left-color: var(--success-color);
    }

    .maturity-domain-item {
        padding: 0.75rem;
        background: var(--light-gray);
        border-radius: 6px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .maturity-score {
        font-weight: 600;
        color: var(--primary-color);
    }

    .maturity-progress {
        width: 100%;
        height: 8px;
        background: rgba(0,0,0,0.1);
        border-radius: 4px;
        margin: 0.5rem 0;
        overflow: hidden;
    }

    .maturity-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--danger-color) 0%, var(--warning-color) 50%, var(--success-color) 100%);
        transition: width 0.3s ease;
    }

    .no-data-message {
        text-align: center;
        color: #95a5a6;
        font-style: italic;
        padding: 3rem 2rem;
    }

    .no-data-message i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .assessment-selector {
        background: #ffffff;
        border-radius: var(--border-radius-card);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--light-gray);
    }

    .form-select-modern {
        border: 2px solid var(--medium-gray);
        border-radius: var(--border-radius-small);
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .form-select-modern:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }

    .risk-appetite-controls {
        background: var(--light-gray);
        border-radius: var(--border-radius-small);
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid var(--medium-gray);
    }

    .config-button {
        background: var(--light-gray);
        border: 1px solid var(--medium-gray);
        border-radius: 25px;
        padding: 0.5rem 1rem;
        color: var(--primary-color);
        font-size: 0.875rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
    }

    .config-button:hover {
        background: var(--accent-color);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        border-color: var(--accent-color);
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .dashboard-title {
            font-size: 1.75rem;
        }
        
        .kpi-number {
            font-size: 2rem;
        }
        
        .chart-container {
            height: 250px !important;
        }
        
        .chart-executive {
            padding: 1.5rem;
        }
        
        .dashboard-header {
            padding: 1.5rem;
        }
    }

    @@media (max-width: 576px) {
        .kpi-container {
            padding: 1rem;
        }
        
        .kpi-number {
            font-size: 1.75rem;
        }
        
        .kpi-label {
            font-size: 0.875rem;
        }
    }
</style>

<div class="executive-dashboard">
<div class="container-fluid py-4">
    <!-- Executive Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="mb-3 mb-lg-0">
                        <h1 class="dashboard-title">
                            <i class="fas fa-shield-alt me-3" style="color: #3498db;"></i>CISO Executive Dashboard
                        </h1>
                        <p class="dashboard-subtitle">Enterprise Security Risk Posture & Key Performance Indicators</p>
                    </div>
                    <div class="text-end">
                        <div class="status-badge mb-3">
                            <i class="fas fa-clock"></i>Last Updated: <span id="lastUpdated">Loading...</span>
                        </div>
                        <div>
                            <button class="refresh-button" id="refreshButton">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Data
                            </button>
                            @if (User.IsInRole("Admin"))
                            {
                                <button class="btn btn-outline-info ms-2" id="checkDatabaseButton" style="border-radius: 25px;">
                                    <i class="fas fa-database me-2"></i>Check Database
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Executive Summary KPIs -->
    <div class="row mb-5">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="executive-card metric-critical h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-exclamation-triangle kpi-icon"></i>
                            <div class="kpi-number" id="totalCriticalHighFindings">--</div>
                            <div class="kpi-label">Critical & High Findings</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="executive-card metric-warning h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-crosshairs kpi-icon"></i>
                            <div class="kpi-number" id="risksAboveAppetite">--</div>
                            <div class="kpi-label">Above Risk Appetite</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="executive-card metric-info h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-chart-line kpi-icon"></i>
                            <div class="kpi-number" id="riskVelocity">--</div>
                            <div class="kpi-label">Risk Velocity (30d)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="executive-card metric-success h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-shield-check kpi-icon"></i>
                            <div class="kpi-number" id="overallComplianceRate">--</div>
                            <div class="kpi-label">Compliance Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Metrics Row -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="executive-card metric-good h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-bullseye kpi-icon"></i>
                            <div class="kpi-number" id="maturityScore">--</div>
                            <div class="kpi-label">Security Maturity Score</div>
                            <small class="text-muted mt-1" id="maturityLevel">--</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="executive-card metric-info h-100">
                <div class="kpi-container">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-clock kpi-icon"></i>
                            <div class="kpi-number" id="avgResolutionTime">--</div>
                            <div class="kpi-label">Avg Resolution Time</div>
                            <small class="text-muted mt-1">days</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Dashboard Sections -->
    
    <!-- Charts Row -->
    <div class="row mb-5">
        <!-- Risk Distribution Chart -->
        <div class="col-lg-6 mb-4">
            <div class="chart-executive">
                <h5>
                    <i class="fas fa-chart-pie"></i>Risk Distribution by Level
                </h5>
                <div class="chart-container">
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Security Maturity Assessment -->
        <div class="col-lg-6 mb-4">
            <div class="chart-executive">
                <h5>
                    <i class="fas fa-bullseye"></i>Security Maturity Assessment
                </h5>
                <div class="maturity-overview" id="maturityOverview">
                    <div class="no-data-message">
                        <i class="fas fa-bullseye"></i>
                        Loading maturity data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Unit Analysis & Compliance -->
    <div class="row mb-5">
        <!-- Business Unit Risk Analysis -->
        <div class="col-lg-8 mb-4">
            <div class="chart-executive h-100">
                <h5>
                    <i class="fas fa-building"></i>Business Unit Risk Analysis
                </h5>
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>Business Unit</th>
                                <th class="text-center">Critical</th>
                                <th class="text-center">High</th>
                                <th class="text-center">Medium</th>
                                <th class="text-center">Low</th>
                            </tr>
                        </thead>
                        <tbody id="businessUnitAnalysis">
                            <tr>
                                <td colspan="5" class="no-data-message">
                                    <i class="fas fa-building"></i>
                                    Loading business unit analysis...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Compliance Framework Status -->
        <div class="col-lg-4 mb-4">
            <div class="chart-executive h-100">
                <h5>
                    <i class="fas fa-clipboard-check"></i>Compliance Frameworks
                </h5>
                <div class="compliance-frameworks" id="complianceFrameworks">
                    <div class="no-data-message">
                        <i class="fas fa-clipboard-check"></i>
                        Loading compliance data...
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Financial Risks and Assets Analysis -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="chart-executive h-100">
                <h5>
                    <i class="fas fa-money-bill-wave"></i>Top Financial Risks
                </h5>
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>Risk Description</th>
                                <th class="text-end">Risk Score</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="topFinancialRisks">
                            <tr>
                                <td colspan="3" class="no-data-message">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Loading financial risk data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Assets with High Risks -->
        <div class="col-lg-6 mb-4">
            <div class="chart-executive h-100">
                <h5>
                    <i class="fas fa-server"></i>Top Assets - High Risk
                </h5>
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th class="text-center">Above Appetite</th>
                                <th class="text-center">Total Risks</th>
                                <th class="text-center">Risk Profile</th>
                            </tr>
                        </thead>
                        <tbody id="topAssetsWithHighRisks">
                            <tr>
                                <td colspan="4" class="no-data-message">
                                    <i class="fas fa-server"></i>
                                    Loading high-risk assets...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
</div>

@section Scripts {
    <script>
        // CISO Executive Dashboard JavaScript
        // FIXED: Added comprehensive null checks to prevent null reference exceptions

        let riskDistributionChart = null;

        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 CISO Dashboard initializing...');
            loadDashboardData();

            // Set up refresh button - with null check
            const refreshButton = document.getElementById('refreshButton');
            if (refreshButton) {
                refreshButton.addEventListener('click', function () {
                    console.log('🔄 Manual refresh triggered');
                    loadDashboardData();
                });
            }


            // Set up check database button - with null check
            const checkDatabaseButton = document.getElementById('checkDatabaseButton');
            if (checkDatabaseButton) {
                checkDatabaseButton.addEventListener('click', function () {
                    console.log('🔄 Checking database status...');
                    checkDatabaseStatus();
                });
            }


            // Load available assessments
            loadAvailableAssessments();
        });


        // Check database status to debug data issues
        function checkDatabaseStatus() {
            fetch('/CISOExecutive/GetDatabaseStatus')
                .then(response => response.json())
                .then(data => {
                    console.log('📊 DATABASE STATUS:', data);
                    
                    // Show alert with database status
                    const message = `
Database Status:
- Total Risks: ${data.totalRisks || 0}
- Open Risks: ${data.openRisks || 0}
- Risks with Score > 0: ${data.risksWithQualitativeScoring || 0}
- Total Risk Score: ${(data.totalRiskScore || 0).toLocaleString()}
- Total Findings: ${data.totalFindings || 0}
- Open Findings: ${data.openFindings || 0}
- Total Assessments: ${data.totalAssessments || 0}
- Completed Assessments: ${data.completedAssessments || 0}
- Qualitative Assessments: ${data.qualitativeAssessments || 0}

Risk Levels: ${JSON.stringify(data.risksByLevel || {})}
Finding Ratings: ${JSON.stringify(data.findingsByRating || {})}
                    `;
                    
                    alert(message);
                    
                    // If no data exists, suggest creating sample data
                    if (!data.totalRisks && !data.totalFindings) {
                        if (confirm('No data found in database. Would you like to create sample data?')) {
                            createSampleFAIRAssessments();
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error checking database:', error);
                    alert('Error checking database: ' + error.message);
                });
        }




        // Load dashboard data with comprehensive error handling
        function loadDashboardData() {
            console.log('🔄 Loading dashboard data...');

            const url = '/CISOExecutive/GetExecutiveDashboardData';

            fetch(url)
                .then(response => {
                    console.log('📡 Dashboard API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Dashboard data received:', data);

                    if (data && data.error) {
                        console.error('❌ Dashboard API returned error:', data.error);
                        showErrorMessage('Error loading dashboard data: ' + data.error);
                        return;
                    }

                    // Update all sections with comprehensive dashboard data
                    updateLastUpdated();
                    updateExecutiveSummaryKPIs(data);
                    updateStrategicMetrics(data);
                    updateRiskDistributionChart(data);
                    updateMaturityOverview(data);
                    updateBusinessUnitAnalysis(data);
                    updateComplianceFrameworks(data);
                    updateFinancialRisksTable(data);
                    updateTopAssetsTable(data);

                    console.log('✅ Dashboard update completed');
                })
                .catch(error => {
                    console.error('❌ Error loading dashboard data:', error);
                    showErrorMessage('Failed to load dashboard data. Please try again.');
                });
        }

        // Show error message to user
        function showErrorMessage(message) {
            // Update last updated time to show error
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = 'Error loading data';
                lastUpdatedElement.className = 'text-danger';
            }

            // You could also show a toast notification here if you have that implemented
            console.error('Showing error to user:', message);
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = new Date().toLocaleString();
                lastUpdatedElement.className = ''; // Remove any error styling
            }
        }

        // Update Executive Summary KPIs
        function updateExecutiveSummaryKPIs(data) {
            console.log('🔄 Updating Executive Summary KPIs with data:', data);

            if (data && data.executiveSummary) {
                const summary = data.executiveSummary;

                // Update primary KPIs
                updateElement('totalCriticalHighFindings', summary.totalCriticalHighFindings || 0);
                updateElement('risksAboveAppetite', summary.risksAboveAppetite || 0);
                updateElement('riskVelocity', summary.riskVelocity || 0);
                updateElement('overallComplianceRate', (summary.assessmentCompletionRate || 0) + '%');

                console.log('✅ Updated Executive Summary KPIs');
            } else {
                console.log('⚠️ No executive summary data available');
                setDefaultKPIValues();
            }
        }

        // Update Strategic Metrics
        function updateStrategicMetrics(data) {
            if (data && data.maturityInsights) {
                const maturity = data.maturityInsights;
                updateElement('maturityScore', (maturity.maturityScore || 0) + '%');
                updateElement('maturityLevel', maturity.overallMaturityLevel || 'Not Assessed');
            }

            if (data && data.executiveSummary) {
                updateElement('avgResolutionTime', (data.executiveSummary.avgResolutionTimeDays || 0).toFixed(1));
            }
        }


        function updateMaturityOverview(data) {
            const container = document.getElementById('maturityOverview');
            if (!container) return;

            if (data && data.maturityInsights && data.maturityInsights.domainMaturityBreakdown) {
                const domains = data.maturityInsights.domainMaturityBreakdown;
                let html = '';
                
                if (domains.length > 0) {
                    domains.slice(0, 6).forEach(domain => {
                        const progressWidth = (domain.currentMaturity / 4) * 100;
                        html += `
                            <div class="maturity-domain-item">
                                <div>
                                    <div style="font-size: 0.875rem; font-weight: 600;">${escapeHtml(domain.domain)}</div>
                                    <div class="maturity-progress">
                                        <div class="maturity-progress-fill" style="width: ${progressWidth}%"></div>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #7f8c8d;">Current: ${domain.currentMaturity}/4 | Target: ${domain.targetMaturity}/4</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="no-data-message"><i class="fas fa-bullseye"></i>No maturity assessments completed</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="no-data-message"><i class="fas fa-bullseye"></i>No maturity data available</div>';
            }
        }

        function updateBusinessUnitAnalysis(data) {
            const tableBody = document.getElementById('businessUnitAnalysis');
            if (!tableBody) return;

            if (data && data.businessUnitAnalysis && data.businessUnitAnalysis.businessUnits) {
                const units = data.businessUnitAnalysis.businessUnits;
                let html = '';
                
                units.forEach(unit => {
                    html += `
                        <tr>
                            <td>
                                <div class="fw-semibold">${escapeHtml(unit.businessUnit)}</div>
                                <small class="text-muted">${unit.totalRisks} total risks</small>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-modern bg-danger">${unit.criticalCount || 0}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-modern bg-warning text-dark">${unit.highCount || 0}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-modern bg-info">${unit.mediumCount || 0}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-modern bg-secondary">${unit.lowCount || 0}</span>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data-message"><i class="fas fa-building"></i>No business unit data available</td></tr>';
            }
        }

        function updateComplianceFrameworks(data) {
            const container = document.getElementById('complianceFrameworks');
            if (!container) return;

            if (data && data.complianceMetrics && data.complianceMetrics.frameworkCompliance) {
                const frameworks = data.complianceMetrics.frameworkCompliance;
                let html = '';
                
                if (frameworks.length > 0) {
                    frameworks.forEach(framework => {
                        const complianceClass = getComplianceClass(framework.complianceRate);
                        html += `
                            <div class="compliance-framework-item ${complianceClass}">
                                <div class="compliance-rate text-${getComplianceColor(framework.complianceRate)}">${framework.complianceRate}%</div>
                                <div class="compliance-framework-name">${escapeHtml(framework.framework)}</div>
                                <div class="compliance-gap-count">${framework.gapsCount} gaps identified</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="no-data-message"><i class="fas fa-clipboard-check"></i>No compliance frameworks assessed</div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="no-data-message"><i class="fas fa-clipboard-check"></i>No compliance data available</div>';
            }
        }


        // Helper functions for the new dashboard
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function setDefaultKPIValues() {
            const defaultKPIs = [
                { id: 'totalCriticalHighFindings', value: 0 },
                { id: 'risksAboveAppetite', value: 0 },
                { id: 'riskVelocity', value: 0 },
                { id: 'overallComplianceRate', value: '0%' }
            ];

            defaultKPIs.forEach(kpi => updateElement(kpi.id, kpi.value));
        }

        function getTrendIcon(trend) {
            switch (trend) {
                case 'increasing': return '<i class="fas fa-arrow-up text-danger"></i>';
                case 'decreasing': return '<i class="fas fa-arrow-down text-success"></i>';
                default: return '<i class="fas fa-arrow-right text-info"></i>';
            }
        }

        function getComplianceClass(rate) {
            if (rate >= 80) return 'high-compliance';
            if (rate >= 60) return 'medium-compliance';
            return 'low-compliance';
        }

        function getComplianceColor(rate) {
            if (rate >= 80) return 'success';
            if (rate >= 60) return 'warning';
            return 'danger';
        }


        // Keep the existing business units table function for compatibility
        function updateBusinessUnitsTable(data) {
            // This function kept for backward compatibility with existing charts
            return updateBusinessUnitAnalysis(data);
        }


        // FIXED: Update financial risks table with null checks
        function updateFinancialRisksTable(data) {
            const tableBody = document.getElementById('topFinancialRisks');
            if (!tableBody) {
                console.error('❌ Financial risks table not found');
                return;
            }

            if (data && data.topFinancialRisks && Array.isArray(data.topFinancialRisks) && data.topFinancialRisks.length > 0) {
                let html = '';
                data.topFinancialRisks.forEach(risk => {
                    if (risk) {
                        const riskDescription = risk.riskDescription || 'Unknown Risk';
                        const asset = risk.asset || 'Unknown Asset';
                        const riskScore = risk.riskScore || 0;
                        const status = risk.status || 'Unknown';

                        html += `
                            <tr>
                                <td>
                                    <div class="fw-semibold text-dark">${escapeHtml(riskDescription)}</div>
                                    <small class="text-muted">${escapeHtml(asset)}</small>
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold" style="color: #27ae60; font-size: 1.1rem;">${riskScore}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-modern bg-${getStatusClass(status.toLowerCase())}">${status.toUpperCase()}</span>
                                </td>
                            </tr>
                        `;
                    }
                });
                tableBody.innerHTML = html;
                console.log(`✅ Updated financial risks table with ${data.topFinancialRisks.length} risks`);
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="no-data-message">
                            <i class="fas fa-money-bill-wave fa-2x mb-2 text-muted d-block"></i>
                            No financial risk data available
                        </td>
                    </tr>`;
                console.log('⚠️ No financial risks data available');
            }
        }

        // Update top assets with high risks table
        function updateTopAssetsTable(data) {
            const tableBody = document.getElementById('topAssetsWithHighRisks');
            if (!tableBody) {
                console.error('❌ Top assets table not found');
                return;
            }

            if (data && data.topAssetsWithHighRisks && Array.isArray(data.topAssetsWithHighRisks) && data.topAssetsWithHighRisks.length > 0) {
                let html = '';
                data.topAssetsWithHighRisks.forEach(asset => {
                    if (asset) {
                        const assetName = asset.asset || 'Unknown Asset';
                        const risksAboveAppetite = asset.risksAboveAppetite || 0;
                        const totalRisks = asset.totalRisks || 0;
                        const criticalCount = asset.criticalCount || 0;
                        const highCount = asset.highCount || 0;
                        const businessUnit = asset.businessUnit || 'Unknown';
                        const totalRiskScore = asset.totalRiskScore || 0;

                        // Create risk profile indicator
                        let profileClass = 'success';
                        let profileText = 'Low';
                        if (risksAboveAppetite >= 3 || criticalCount >= 2) {
                            profileClass = 'danger';
                            profileText = 'Critical';
                        } else if (risksAboveAppetite >= 2 || criticalCount >= 1 || highCount >= 3) {
                            profileClass = 'warning';
                            profileText = 'High';
                        } else if (risksAboveAppetite >= 1 || highCount >= 1) {
                            profileClass = 'info';
                            profileText = 'Medium';
                        }

                        html += `
                            <tr>
                                <td>
                                    <div class="fw-semibold text-dark">${escapeHtml(assetName)}</div>
                                    <small class="text-muted">${escapeHtml(businessUnit)} • ${totalRiskScore || 0} risk score</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-modern bg-danger">${risksAboveAppetite}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-modern bg-secondary">${totalRisks}</span>
                                    ${criticalCount > 0 ? `<span class="badge badge-modern bg-danger ms-1">${criticalCount}C</span>` : ''}
                                    ${highCount > 0 ? `<span class="badge badge-modern bg-warning text-dark ms-1">${highCount}H</span>` : ''}
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-modern bg-${profileClass}">${profileText}</span>
                                </td>
                            </tr>
                        `;
                    }
                });
                tableBody.innerHTML = html;
                console.log(`✅ Updated top assets table with ${data.topAssetsWithHighRisks.length} assets`);
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="no-data-message">
                            <i class="fas fa-server fa-2x mb-2 text-muted d-block"></i>
                            No high-risk assets found
                        </td>
                    </tr>`;
                console.log('⚠️ No top assets data available');
            }
        }

        // FIXED: Update risk distribution chart with null checks
        function updateRiskDistributionChart(data) {
            const ctx = document.getElementById('riskDistributionChart');
            if (!ctx) {
                console.error('❌ Risk distribution chart canvas not found');
                return;
            }

            // Destroy existing chart if it exists
            if (riskDistributionChart) {
                riskDistributionChart.destroy();
                riskDistributionChart = null;
            }

            // Set default data
            let chartData = {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#6c757d']
                }]
            };

            // Use real data if available
            if (data && data.riskDistribution) {
                const dist = data.riskDistribution;
                chartData.datasets[0].data = [
                    dist.critical || 0,
                    dist.high || 0,
                    dist.medium || 0,
                    dist.low || 0
                ];
            }

            try {
                riskDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                console.log('✅ Updated risk distribution chart');
            } catch (error) {
                console.error('❌ Error creating risk distribution chart:', error);
            }
        }


        // Utility functions with null checks
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '$0';
            }
            try {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            } catch (error) {
                console.error('Error formatting currency:', error);
                return '$0';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStatusClass(status) {
            if (!status) return 'secondary';
            const statusLower = status.toLowerCase();
            switch (statusLower) {
                case 'critical': return 'danger';
                case 'warning': return 'warning';
                case 'good': return 'success';
                case 'excellent': return 'primary';
                case 'open': return 'danger';
                case 'closed': return 'success';
                case 'in progress': return 'warning';
                default: return 'secondary';
            }
        }

        function getRiskBadgeClass(riskRating) {
            if (!riskRating) return 'secondary';
            const riskLower = riskRating.toLowerCase();
            switch (riskLower) {
                case 'critical': return 'danger';
                case 'high': return 'warning';
                case 'medium': return 'info';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }
    </script>
}
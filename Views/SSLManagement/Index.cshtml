@model IEnumerable<CyberRiskApp.Models.SSLCertificate>
@{
    ViewData["Title"] = "SSL Certificate Management";
    var settings = ViewBag.Settings as CyberRiskApp.Models.SSLSettings;
    var dashboardData = ViewBag.DashboardData as Dictionary<string, object>;
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-lock me-2"></i>SSL Certificate Management</h2>
            <div>
                <a asp-action="Settings" class="btn btn-outline-primary me-2">
                    <i class="fas fa-cog me-1"></i>SSL Settings
                </a>
                <a asp-action="Upload" class="btn btn-primary">
                    <i class="fas fa-upload me-1"></i>Upload Certificate
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h4 class="text-primary">@(dashboardData?["TotalCertificates"] ?? 0)</h4>
                <p class="card-text">Total Certificates</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h4 class="text-success">@(dashboardData?["ActiveCertificates"] ?? 0)</h4>
                <p class="card-text">Active Certificates</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h4 class="text-warning">@(dashboardData?["ExpiringCertificates"] ?? 0)</h4>
                <p class="card-text">Expiring Soon</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h4 class="text-danger">@(dashboardData?["ExpiredCertificates"] ?? 0)</h4>
                <p class="card-text">Expired</p>
            </div>
        </div>
    </div>
</div>

<!-- Current Settings Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Current SSL Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>HTTPS Redirection:</strong>
                        @if (settings?.EnableHttpsRedirection == true)
                        {
                            <span class="badge bg-success">Enabled</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Disabled</span>
                        }
                    </div>
                    <div class="col-md-4">
                        <strong>Require HTTPS:</strong>
                        @if (settings?.RequireHttps == true)
                        {
                            <span class="badge bg-success">Yes</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No</span>
                        }
                    </div>
                    <div class="col-md-4">
                        <strong>HTTPS Port:</strong>
                        <span class="badge bg-info">@(settings?.HttpsPort ?? 443)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Certificates Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-certificate me-2"></i>SSL Certificates</h5>
            </div>
            <div class="card-body">
                @if (Model?.Any() == true)
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Issuer</th>
                                    <th>Valid From</th>
                                    <th>Valid To</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cert in Model)
                                {
                                    <tr class="@(cert.IsExpired ? "table-danger" : cert.DaysUntilExpiry <= 30 ? "table-warning" : "")">
                                        <td>
                                            <strong>@cert.Name</strong>
                                            @if (cert.IsActive)
                                            {
                                                <span class="badge bg-success ms-2">Active</span>
                                            }
                                        </td>
                                        <td>@cert.Subject</td>
                                        <td>@cert.Issuer</td>
                                        <td>@cert.ValidFrom.ToString("yyyy-MM-dd")</td>
                                        <td>@cert.ValidTo.ToString("yyyy-MM-dd")</td>
                                        <td>
                                            @if (cert.IsExpired)
                                            {
                                                <span class="badge bg-danger">Expired</span>
                                            }
                                            else if (cert.DaysUntilExpiry <= 30)
                                            {
                                                <span class="badge bg-warning">Expires in @cert.DaysUntilExpiry days</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Valid</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a asp-action="Details" asp-route-id="@cert.Id" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                @if (!cert.IsActive && cert.IsValid)
                                                {
                                                    <form asp-action="SetActive" asp-route-id="@cert.Id" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-success" title="Set as Active">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </form>
                                                }
                                                <form asp-action="Install" asp-route-id="@cert.Id" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-primary" title="Install to System">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </form>
                                                <a asp-action="Export" asp-route-id="@cert.Id" class="btn btn-sm btn-secondary" title="Export Certificate">
                                                    <i class="fas fa-file-export"></i>
                                                </a>
                                                @if (!cert.IsActive)
                                                {
                                                    <form asp-action="Delete" asp-route-id="@cert.Id" method="post" class="d-inline" 
                                                          onsubmit="return confirm('Are you sure you want to delete this certificate?')">
                                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No SSL certificates found. <a asp-action="Upload">Upload your first certificate</a> to get started.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-refresh dashboard data every 30 seconds
        setInterval(function() {
            $.get('@Url.Action("GetDashboardData")', function(data) {
                if (data.success) {
                    // Update dashboard cards
                    location.reload(); // Simple refresh for now
                }
            });
        }, 30000);
        
        // Show success/error messages
        @if (TempData["Success"] != null)
        {
            <text>
            $(document).ready(function() {
                toastr.success('@TempData["Success"]');
            });
            </text>
        }
        @if (TempData["Error"] != null)
        {
            <text>
            $(document).ready(function() {
                toastr.error('@TempData["Error"]');
            });
            </text>
        }
    </script>
}
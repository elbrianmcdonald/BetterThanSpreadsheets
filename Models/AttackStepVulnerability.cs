using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace CyberRiskApp.Models
{
    [Table("AttackStepVulnerabilities")]
    public class AttackStepVulnerability : IAuditableEntity
    {
        [Key]
        public int Id { get; set; }

        [Required]
        [StringLength(200)]
        [Display(Name = "Vulnerability Title")]
        public string Title { get; set; } = string.Empty;

        [Required]
        [StringLength(500)]
        [Display(Name = "Description")]
        public string Description { get; set; } = string.Empty;

        [Display(Name = "MITRE ATT&CK Technique")]
        public int? MitreTechniqueId { get; set; }

        [Display(Name = "Custom Technique")]
        [StringLength(200)]
        public string? CustomTechnique { get; set; }

        // Vulnerability Distribution (likelihood of successful exploitation)
        [Required]
        [Display(Name = "Vulnerability Minimum Likelihood")]
        [Range(0, 1, ErrorMessage = "Vulnerability Minimum must be between 0 and 1")]
        public double VulnMinimum { get; set; }

        [Required]
        [Display(Name = "Vulnerability Maximum Likelihood")]
        [Range(0, 1, ErrorMessage = "Vulnerability Maximum must be between 0 and 1")]
        public double VulnMaximum { get; set; }

        [Display(Name = "Vulnerability Most Likely")]
        public double VulnMostLikely { get; set; } // Auto-calculated

        // Control associations (JSON arrays of control IDs)
        [Display(Name = "Preventative Controls")]
        public string PreventativeControls { get; set; } = "[]"; // JSON array

        [Display(Name = "Detective Controls")]
        public string DetectiveControls { get; set; } = "[]"; // JSON array

        [Display(Name = "Data Sources")]
        public string DataSources { get; set; } = "[]"; // JSON array

        // Linking to the next step in the attack chain
        [Display(Name = "Next Vulnerability")]
        public int? NextVulnerabilityId { get; set; }

        [Display(Name = "Loss Event")]
        public int? LossEventId { get; set; }

        // Order in the attack chain
        [Display(Name = "Step Order")]
        public int StepOrder { get; set; } = 1;

        // Audit fields
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
        public string CreatedBy { get; set; } = string.Empty;
        public string UpdatedBy { get; set; } = string.Empty;
        
        [Timestamp]
        public byte[]? RowVersion { get; set; }

        // Navigation properties
        [ForeignKey("MitreTechniqueId")]
        public virtual MitreTechnique? MitreTechnique { get; set; }

        [ForeignKey("NextVulnerabilityId")]
        public virtual AttackStepVulnerability? NextVulnerability { get; set; }

        [ForeignKey("LossEventId")]
        public virtual LossEvent? LossEvent { get; set; }

        // References from other vulnerabilities
        public virtual ICollection<AttackStepVulnerability> PreviousVulnerabilities { get; set; } = new List<AttackStepVulnerability>();
        public virtual ICollection<ThreatEvent> ThreatEvents { get; set; } = new List<ThreatEvent>();
    }
}